<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraStar Lyrics Editor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        // Simple SVG icons
        const Upload = () => (
            <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className || "w-5 h-5"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const HelpIcon = ({ className }) => (
            <svg className={className || "w-4 h-4"} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const UltraStarLyricsEditor = () => {
            const [originalLines, setOriginalLines] = useState([]);
            const [newLyrics, setNewLyrics] = useState('');
            const [syncedLines, setSyncedLines] = useState([]);
            const [headerInfo, setHeaderInfo] = useState({});
            const [editableTitle, setEditableTitle] = useState('');
            const [editableLanguage, setEditableLanguage] = useState('');
            const [gapMinutes, setGapMinutes] = useState(0);
            const [gapSeconds, setGapSeconds] = useState(0);
            const [gapMilliseconds, setGapMilliseconds] = useState(0);
            const [outputText, setOutputText] = useState('');
            const [showOutput, setShowOutput] = useState(false);
            const [notification, setNotification] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [syncWarnings, setSyncWarnings] = useState([]);
            const [isDragging, setIsDragging] = useState(false);

            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const parseUltraStarFile = (content) => {
                try {
                    const lines = content.split('\n');
                    const header = {};
                    const noteLines = [];

                    lines.forEach(line => {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('#')) {
                            const [key, ...valueParts] = trimmedLine.substring(1).split(':');
                            header[key.trim()] = valueParts.join(':').trim();
                        } else if (trimmedLine.match(/^[:*FR-]/) || trimmedLine === 'E') {
                            noteLines.push(trimmedLine);
                        }
                    });

                    if (noteLines.length === 0) {
                        showNotification('No valid note lines found in file', 'error');
                        return [];
                    }

                    setHeaderInfo(header);
                    setEditableTitle(header.TITLE || '');
                    setEditableLanguage(header.LANGUAGE || '');

                    // Parse GAP value (in milliseconds) and convert to minutes, seconds, milliseconds
                    const gapValue = parseInt(header.GAP || '0', 10);
                    const minutes = Math.floor(gapValue / 60000);
                    const seconds = Math.floor((gapValue % 60000) / 1000);
                    const milliseconds = gapValue % 1000;
                    setGapMinutes(minutes);
                    setGapSeconds(seconds);
                    setGapMilliseconds(milliseconds);

                    setOriginalLines(noteLines);
                    showNotification(`File loaded: ${noteLines.length} lines`, 'success');
                    return noteLines;
                } catch (error) {
                    showNotification('Error parsing UltraStar file: ' + error.message, 'error');
                    return [];
                }
            };

            const handleOriginalFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!file.name.endsWith('.txt')) {
                        showNotification('Please select a .txt file', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        parseUltraStarFile(event.target.result);
                    };
                    reader.onerror = () => {
                        showNotification('Error reading file', 'error');
                    };
                    reader.readAsText(file);
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragging(false);

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (!file.name.endsWith('.txt')) {
                        showNotification('Please select a .txt file', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        parseUltraStarFile(event.target.result);
                    };
                    reader.onerror = () => {
                        showNotification('Error reading file', 'error');
                    };
                    reader.readAsText(file);
                }
            };

            const handleNewLyricsChange = (e) => {
                setNewLyrics(e.target.value);
            };

            const handleNewLyricsFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setNewLyrics(event.target.result);
                        showNotification('Lyrics file loaded', 'success');
                    };
                    reader.onerror = () => {
                        showNotification('Error reading lyrics file', 'error');
                    };
                    reader.readAsText(file);
                }
            };

            const loadOriginalLyrics = () => {
                if (originalLines.length === 0) {
                    showNotification('No original file loaded', 'error');
                    return;
                }

                try {
                    const phrases = [];
                    let currentPhrase = [];

                    originalLines.forEach(line => {
                        if (line.match(/^[:*FR]/)) {
                            // Extract the text from the note line
                            const parts = line.split(' ');
                            const text = parts.slice(4).join(' ').trim();
                            if (text) {
                                currentPhrase.push(text);
                            }
                        } else if (line.startsWith('-')) {
                            // End of phrase
                            if (currentPhrase.length > 0) {
                                phrases.push(currentPhrase.join('|'));
                                currentPhrase = [];
                            }
                        }
                    });

                    // Add last phrase if any
                    if (currentPhrase.length > 0) {
                        phrases.push(currentPhrase.join('|'));
                    }

                    const lyricsText = phrases.join('\n');
                    setNewLyrics(lyricsText);
                    showNotification('Original lyrics loaded with syllable separators', 'success');
                } catch (error) {
                    showNotification('Error loading original lyrics: ' + error.message, 'error');
                }
            };

            const extractWords = () => {
                const lines = newLyrics.split('\n');
                const phrases = [];
                
                lines.forEach(line => {
                    // Clean the line of structural markers
                    const cleanLine = line.replace(/\[.*?]/g, '').trim();
                    if (cleanLine) {
                        // Split by spaces to get words
                        const words = cleanLine.split(/\s+/).filter(w => w.length > 0);
                        const syllables = [];

                        // Split each word by | to get syllables and track word boundaries
                        words.forEach((word, wordIndex) => {
                            const wordSyllables = word.split('|').filter(s => s.length > 0);
                            wordSyllables.forEach((syllable, syllableIndex) => {
                                syllables.push({
                                    text: syllable,
                                    isLastInWord: syllableIndex === wordSyllables.length - 1,
                                    isLastInPhrase: wordIndex === words.length - 1 && syllableIndex === wordSyllables.length - 1
                                });
                            });
                        });

                        if (syllables.length > 0) {
                            phrases.push(syllables);
                        }
                    }
                });
                
                return phrases;
            };

            const autoSync = () => {
                setIsLoading(true);
                setSyncWarnings([]);
                const warnings = [];

                try {
                    const newPhrases = extractWords();

                    // Group note lines by blocks separated by pauses
                    const noteBlocks = [];
                    let currentBlock = [];

                    originalLines.forEach(line => {
                        if (line.match(/^[:*FR]/)) {
                            currentBlock.push(line);
                        } else if (line.startsWith('-')) {
                            if (currentBlock.length > 0) {
                                noteBlocks.push(currentBlock);
                                currentBlock = [];
                            }
                        }
                    });
                    if (currentBlock.length > 0) {
                        noteBlocks.push(currentBlock);
                    }

                    console.log('Note blocks:', noteBlocks.length);
                    console.log('New phrases:', newPhrases.length);

                    // Check for mismatch
                    if (noteBlocks.length !== newPhrases.length) {
                        warnings.push(`Warning: ${noteBlocks.length} note blocks but ${newPhrases.length} lyric lines. Synchronization may be imperfect.`);
                    }

                    // Count total syllables
                    const totalNotes = noteBlocks.reduce((sum, block) => sum + block.length, 0);
                    const totalSyllables = newPhrases.reduce((sum, phrase) => sum + phrase.length, 0);

                    if (totalNotes !== totalSyllables) {
                        warnings.push(`Warning: ${totalNotes} notes but ${totalSyllables} syllables. Some notes may be empty or unused.`);
                    }

                    // Distribute syllables across blocks
                    const synced = [];
                    let blockIndex = 0;
                    let syllableIndexInBlock = 0;

                    originalLines.forEach(line => {
                        if (line.startsWith('-')) {
                            synced.push({ type: 'break', line: line, original: '' });
                            // Move to next block after a pause
                            if (syllableIndexInBlock > 0) {
                                blockIndex++;
                                syllableIndexInBlock = 0;
                            }
                        } else if (line.match(/^[:*FR]/)) {
                            const parts = line.split(' ');
                            const type = parts[0];
                            const start = parts[1];
                            const duration = parts[2];
                            const pitch = parts[3];
                            const originalText = parts.slice(4).join(' ');

                            let newText = '';
                            if (blockIndex < newPhrases.length) {
                                const currentPhrase = newPhrases[blockIndex];
                                if (syllableIndexInBlock < currentPhrase.length) {
                                    const syllableInfo = currentPhrase[syllableIndexInBlock];
                                    newText = syllableInfo.text;
                                    // Add space after the last syllable of each word, except if it's the last word of the phrase
                                    if (syllableInfo.isLastInWord && !syllableInfo.isLastInPhrase) {
                                        newText += ' ';
                                    }
                                }
                                syllableIndexInBlock++;
                            }

                            const newLine = `${type} ${start} ${duration} ${pitch} ${newText}`;
                            synced.push({ type: 'note', line: newLine, original: originalText });
                        } else if (line.trim() === 'E') {
                            synced.push({ type: 'end', line: line, original: '' });
                        } else {
                            synced.push({ type: 'other', line: line, original: '' });
                        }
                    });

                    setSyncedLines(synced);
                    setSyncWarnings(warnings);

                    if (warnings.length === 0) {
                        showNotification('Synchronization completed successfully!', 'success');
                    } else {
                        showNotification('Synchronization completed with warnings', 'warning');
                    }
                } catch (error) {
                    showNotification('Error during synchronization: ' + error.message, 'error');
                } finally {
                    setIsLoading(false);
                }
            };

            const generateOutput = () => {
                try {
                    let output = '';

                    // Calculate GAP value in milliseconds
                    const totalGapMs = (gapMinutes * 60000) + (gapSeconds * 1000) + gapMilliseconds;

                    Object.keys(headerInfo).forEach(key => {
                        if (key === 'LANGUAGE') {
                            output += `#${key}:${editableLanguage}\n`;
                        } else if (key === 'TITLE') {
                            output += `#${key}:${editableTitle}\n`;
                        } else if (key === 'GAP') {
                            // Only include GAP if the value is not 0
                            if (totalGapMs !== 0) {
                                output += `#${key}:${totalGapMs}\n`;
                            }
                        } else {
                            output += `#${key}:${headerInfo[key]}\n`;
                        }
                    });

                    // If GAP was not in the original file but has a non-zero value, add it
                    if (!headerInfo.GAP && totalGapMs !== 0) {
                        output += `#GAP:${totalGapMs}\n`;
                    }

                    syncedLines.forEach(item => {
                        output += item.line + '\n';
                    });

                    setOutputText(output);
                    setShowOutput(true);
                    showNotification('File generated successfully!', 'success');
                } catch (error) {
                    showNotification('Error generating file: ' + error.message, 'error');
                }
            };

            const copyToClipboard = () => {
                navigator.clipboard.writeText(outputText)
                    .then(() => {
                        showNotification('Copied to clipboard!', 'success');
                    })
                    .catch(() => {
                        showNotification('Failed to copy to clipboard', 'error');
                    });
            };

            const downloadFile = () => {
                const blob = new Blob([outputText], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'song_new.txt';
                link.click();
                window.URL.revokeObjectURL(url);
                showNotification('File downloaded!', 'success');
            };

            const updateSyncedLine = (index, newText) => {
                const newSynced = [...syncedLines];
                const item = newSynced[index];
                const parts = item.line.split(' ');
                const newLine = parts.slice(0, 4).join(' ') + ' ' + newText;
                newSynced[index] = { ...item, line: newLine };
                setSyncedLines(newSynced);
            };

            return (
                <div className="w-full max-w-6xl mx-auto p-6 bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
                    {/* Toast Notification */}
                    {notification && (
                        <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${
                            notification.type === 'success' ? 'bg-green-500 text-white' :
                            notification.type === 'error' ? 'bg-red-500 text-white' :
                            notification.type === 'warning' ? 'bg-yellow-500 text-white' :
                            'bg-blue-500 text-white'
                        }`}>
                            <div className="flex items-center gap-2">
                                <span className="text-lg">
                                    {notification.type === 'success' ? '‚úì' :
                                     notification.type === 'error' ? '‚úï' :
                                     notification.type === 'warning' ? '‚ö†' : '‚Ñπ'}
                                </span>
                                <span>{notification.message}</span>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <h1 className="text-3xl font-bold text-purple-600 mb-6">
                            UltraStar Lyrics Editor
                        </h1>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div
                                className={`border-2 border-dashed rounded-lg p-4 transition-colors ${
                                    isDragging
                                        ? 'border-purple-500 bg-purple-100'
                                        : 'border-purple-300 bg-white'
                                }`}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                            >
                                <label className="flex flex-col items-center cursor-pointer">
                                    <div className="text-purple-500 mb-2">
                                        <Upload />
                                    </div>
                                    <span className="text-sm font-medium text-gray-700 mb-2">
                                        Load Original UltraStar File
                                    </span>
                                    <span className="text-xs text-gray-500 mb-2">
                                        Click or drag and drop
                                    </span>
                                    <input
                                        type="file"
                                        accept=".txt"
                                        onChange={handleOriginalFileUpload}
                                        className="hidden"
                                    />
                                    {originalLines.length > 0 ? (
                                        <div className="text-center">
                                            {headerInfo.TITLE && (
                                                <div className="text-sm font-semibold text-purple-700">
                                                    {headerInfo.TITLE}
                                                </div>
                                            )}
                                            {headerInfo.ARTIST && (
                                                <div className="text-sm text-purple-600">
                                                    {headerInfo.ARTIST}
                                                </div>
                                            )}
                                            <div className="text-xs text-gray-500 mt-1">
                                                {originalLines.length} lines loaded
                                            </div>
                                        </div>
                                    ) : (
                                        <span className="text-xs text-gray-500">No file</span>
                                    )}
                                </label>
                            </div>
                            
                            <div className="border-2 border-purple-300 rounded-lg p-4">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                        <label className="text-sm font-medium text-gray-700">
                                            New lyrics
                                        </label>
                                        <div className="relative group">
                                            <button
                                                type="button"
                                                className="text-purple-500 hover:text-purple-700 transition focus:outline-none focus:ring-2 focus:ring-purple-500 rounded"
                                                aria-label="Help"
                                            >
                                                <HelpIcon className="w-4 h-4" />
                                            </button>
                                            <div className="absolute left-0 top-6 w-72 bg-gray-900 text-white text-xs rounded-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus-within:opacity-100 group-focus-within:visible transition-all duration-200 z-10 shadow-lg">
                                                <p className="font-semibold mb-2">üìù How synchronization works:</p>
                                                <ul className="space-y-1 mb-2">
                                                    <li>‚Ä¢ Each line is synced with original timings</li>
                                                    <li>‚Ä¢ Lines are split into syllables</li>
                                                    <li>‚Ä¢ Each syllable gets one note</li>
                                                </ul>
                                                <p className="font-semibold mb-1">üî§ Syllable separator:</p>
                                                <p className="mb-1">Use <span className="font-mono bg-gray-700 px-1 rounded">|</span> to split words into syllables</p>
                                                <p className="italic text-gray-300">Example: hel|lo wor|ld</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            type="button"
                                            onClick={loadOriginalLyrics}
                                            disabled={originalLines.length === 0}
                                            className={`px-3 py-1 rounded text-xs transition ${
                                                originalLines.length === 0
                                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                                    : 'bg-blue-500 text-white hover:bg-blue-600'
                                            }`}
                                            title="Load original lyrics with syllable separators"
                                        >
                                            üìÑ Load original
                                        </button>
                                        <label className="cursor-pointer bg-purple-500 text-white px-3 py-1 rounded text-xs hover:bg-purple-600 transition">
                                            üìÅ Load file
                                            <input
                                                type="file"
                                                accept=".txt"
                                                onChange={handleNewLyricsFileUpload}
                                                className="hidden"
                                            />
                                        </label>
                                    </div>
                                </div>
                                <textarea
                                    className="w-full h-32 p-2 border border-gray-300 rounded text-sm"
                                    placeholder="Paste your new lyrics here or load a file..."
                                    value={newLyrics}
                                    onChange={handleNewLyricsChange}
                                />
                            </div>
                        </div>

                        {originalLines.length > 0 && (
                            <div className="mb-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Song Title
                                        </label>
                                        <input
                                            type="text"
                                            value={editableTitle}
                                            onChange={(e) => setEditableTitle(e.target.value)}
                                            className="w-full px-3 py-2 border border-purple-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            placeholder="Enter song title..."
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Language
                                        </label>
                                        <input
                                            type="text"
                                            value={editableLanguage}
                                            onChange={(e) => setEditableLanguage(e.target.value)}
                                            className="w-full px-3 py-2 border border-purple-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                            placeholder="Enter language..."
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        GAP (delay before the song starts)
                                    </label>
                                    <div className="flex gap-2 items-center">
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 mb-1">Minutes</label>
                                            <input
                                                type="number"
                                                min="0"
                                                value={gapMinutes}
                                                onChange={(e) => setGapMinutes(Math.max(0, parseInt(e.target.value) || 0))}
                                                className="w-full px-3 py-2 border border-purple-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                placeholder="0"
                                            />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 mb-1">Seconds</label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="59"
                                                value={gapSeconds}
                                                onChange={(e) => setGapSeconds(Math.max(0, Math.min(59, parseInt(e.target.value) || 0)))}
                                                className="w-full px-3 py-2 border border-purple-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                placeholder="0"
                                            />
                                        </div>
                                        <div className="flex-1">
                                            <label className="block text-xs text-gray-600 mb-1">Milliseconds</label>
                                            <input
                                                type="number"
                                                min="0"
                                                max="999"
                                                value={gapMilliseconds}
                                                onChange={(e) => setGapMilliseconds(Math.max(0, Math.min(999, parseInt(e.target.value) || 0)))}
                                                className="w-full px-3 py-2 border border-purple-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1">
                                        Total: {(gapMinutes * 60000) + (gapSeconds * 1000) + gapMilliseconds} ms
                                    </p>
                                </div>
                            </div>
                        )}

                        {originalLines.length > 0 && newLyrics && (
                            <div className="mb-6 text-center">
                                <button
                                    onClick={autoSync}
                                    disabled={isLoading}
                                    className={`px-6 py-3 rounded-lg font-semibold transition inline-flex items-center gap-2 ${
                                        isLoading
                                            ? 'bg-gray-400 cursor-not-allowed'
                                            : 'bg-purple-600 hover:bg-purple-700 text-white'
                                    }`}
                                    type="button"
                                >
                                    {isLoading ? (
                                        <>
                                            <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span>Synchronizing...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>üéµ</span>
                                            <span>Auto-sync</span>
                                        </>
                                    )}
                                </button>
                                <p className="text-xs text-gray-600 mt-2">
                                    Lyrics will be aligned to original timings
                                </p>
                            </div>
                        )}

                        {syncWarnings.length > 0 && (
                            <div className="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                                <div className="flex items-start">
                                    <span className="text-yellow-600 text-xl mr-3">‚ö†</span>
                                    <div className="flex-1">
                                        <h3 className="text-sm font-semibold text-yellow-800 mb-2">Synchronization Warnings</h3>
                                        <ul className="text-sm text-yellow-700 space-y-1">
                                            {syncWarnings.map((warning, index) => (
                                                <li key={index}>‚Ä¢ {warning}</li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        )}

                        {syncedLines.length > 0 && (
                            <div className="mb-6">
                                <h2 className="text-xl font-semibold text-purple-600 mb-3">
                                    Preview and Edit
                                </h2>
                                <div className="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                                    {syncedLines.map((item, index) => {
                                        if (item.type === 'break') {
                                            return (
                                                <div key={index} className="text-gray-400 text-sm py-1">
                                                    {item.line}
                                                </div>
                                            );
                                        }
                                        
                                        if (item.type === 'end') {
                                            return (
                                                <div key={index} className="text-gray-600 font-bold text-sm py-1">
                                                    {item.line}
                                                </div>
                                            );
                                        }
                                        
                                        if (item.type === 'note') {
                                            const parts = item.line.split(' ');
                                            const text = parts.slice(4).join(' ');
                                            return (
                                                <div key={index} className="flex items-center gap-2 py-1">
                                                    <span className="text-xs text-gray-500 w-16 flex-shrink-0">
                                                        {parts[0]} {parts[1]}
                                                    </span>
                                                    <span className="text-xs text-blue-600 w-32 flex-shrink-0 italic truncate" title={item.original}>
                                                        {item.original}
                                                    </span>
                                                    <input
                                                        type="text"
                                                        value={text}
                                                        onChange={(e) => updateSyncedLine(index, e.target.value)}
                                                        className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                                        placeholder="Enter text..."
                                                    />
                                                </div>
                                            );
                                        }
                                        
                                        return (
                                            <div key={index} className="text-gray-600 text-sm py-1">
                                                {item.line}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {syncedLines.length > 0 && (
                            <div className="text-center mb-6">
                                <button
                                    type="button"
                                    onClick={generateOutput}
                                    className="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition inline-flex items-center gap-2"
                                >
                                    <Download className="w-5 h-5" />
                                    Generate Final File
                                </button>
                            </div>
                        )}

                        {showOutput && (
                            <div className="mb-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h2 className="text-xl font-semibold text-purple-600">
                                        UltraStar File
                                    </h2>
                                    <div className="flex gap-2">
                                        <button
                                            type="button"
                                            onClick={copyToClipboard}
                                            className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition"
                                        >
                                            üìã Copy
                                        </button>
                                        <button
                                            type="button"
                                            onClick={downloadFile}
                                            className="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 transition inline-flex items-center gap-1"
                                        >
                                            <Download className="w-4 h-4" />
                                            Download
                                        </button>
                                    </div>
                                </div>
                                <textarea
                                    value={outputText}
                                    readOnly
                                    className="w-full h-96 p-4 border-2 border-green-300 rounded-lg font-mono text-xs bg-gray-50"
                                />
                                <p className="text-sm text-gray-600 mt-2">
                                    ‚úÖ Copy or download this file to use with UltraStar
                                </p>
                            </div>
                        )}

                        <div className="mt-8 bg-blue-50 rounded-lg p-4">
                            <h3 className="font-semibold text-blue-900 mb-2">üìã Instructions</h3>
                            <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                                <li>Load your original UltraStar file</li>
                                <li>Paste the new lyrics in the text area</li>
                                <li>Click "Auto-sync"</li>
                                <li>Review and adjust manually if necessary</li>
                                <li>Generate and copy the synchronized file</li>
                            </ol>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<UltraStarLyricsEditor />, document.getElementById('root'));
    </script>
</body>
</html>